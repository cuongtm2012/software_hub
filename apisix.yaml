---
apisix:
  node_listen: 9080
  enable_heartbeat: true
  enable_admin: true
  enable_admin_cors: true
  enable_ipv6: false
  
  enable_control: true
  control:
    ip: "0.0.0.0"
    port: 9092

nginx_config:
  error_log: "/dev/stderr"
  error_log_level: "warn"
  worker_rlimit_nofile: 20480
  event:
    worker_connections: 10620

etcd:
  timeout: 30
  prefix: "/apisix"
  host:
    - "http://etcd:2379"

deployment:
  admin:
    admin_key:
      - name: "admin"
        key: edd1c9f034335f136f87ad84b625c8f1
        role: admin
    enable_admin_cors: true
    admin_listen:
      ip: 0.0.0.0
      port: 9180
    https_admin: false
    admin_api_mtls:
      admin_ssl_cert: ""
      admin_ssl_cert_key: ""
      admin_ssl_ca_cert: ""

  role: traditional
  role_traditional:
    config_provider: etcd

  etcd:
    timeout: 30
    prefix: "/apisix"
    host:
      - "http://etcd:2379"

plugin_attr:
  log-rotate:
    interval: 3600
    max_kept: 168
    enable_compression: false
  skywalking:
    service_name: APISIX
    service_instance_name: "APISIX Instance Name"
    endpoint_addr: http://127.0.0.1:12800
  prometheus:
    export_uri: /apisix/prometheus/metrics
    metric_prefix: apisix_
    enable_export_server: true
    export_addr:
      ip: 0.0.0.0
      port: 9091

# Static route configuration to bypass admin API issues
routes:
  - id: "notification-service"
    name: "notification-service"
    uri: "/api/notifications/*"
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
    upstream:
      type: roundrobin
      nodes:
        "softwarehub-notification-service:3003": 1
      timeout:
        connect: 60
        send: 60
        read: 60
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        expose_headers: "*"
        max_age: 86400
        allow_credential: true
      proxy-rewrite:
        regex_uri: ["^/api/notifications/(.*)", "/$1"]

  - id: "email-service"
    name: "email-service"
    uri: "/api/email/*"
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
    upstream:
      type: roundrobin
      nodes:
        "softwarehub-email-service:3001": 1
      timeout:
        connect: 60
        send: 60
        read: 60
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        expose_headers: "*"
        max_age: 86400
        allow_credential: true
      proxy-rewrite:
        regex_uri: ["^/api/email/(.*)", "/$1"]

  - id: "chat-service"
    name: "chat-service"
    uri: "/api/chat/*"
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
    upstream:
      type: roundrobin
      nodes:
        "softwarehub-chat-service:3002": 1
      timeout:
        connect: 60
        send: 60
        read: 60
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        expose_headers: "*"
        max_age: 86400
        allow_credential: true
      proxy-rewrite:
        regex_uri: ["^/api/chat/(.*)", "/$1"]